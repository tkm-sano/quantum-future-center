{%- assign theme_key = include.theme_key -%}
{%- if theme_key == nil -%}{%- assign theme_key = page.theme -%}{%- endif -%}
{%- if theme_key == "" -%}{%- assign theme_key = page.theme -%}{%- endif -%}
{%- if theme_key == nil -%}{%- assign theme_key = "center" -%}{%- endif -%}
{%- if theme_key == "" -%}{%- assign theme_key = "center" -%}{%- endif -%}
{%- assign theme_key = theme_key | downcase | strip -%}

{%- assign nav_data_key = "nav_" | append: theme_key -%}
{%- assign nav = site.data[nav_data_key] -%}
{%- if nav == nil or nav == empty -%}{%- assign nav = site.data["nav_center"] -%}{%- endif -%}
{%- if nav.items -%}{%- assign nav = nav.items -%}{%- endif -%}

{%- assign lang = page.lang -%}
{%- if lang == nil -%}{%- assign lang = site.lang -%}{%- endif -%}
{%- if lang == "" -%}{%- assign lang = site.lang -%}{%- endif -%}
{%- if lang == nil -%}{%- assign lang = "ja" -%}{%- endif -%}
{%- if lang == "" -%}{%- assign lang = "ja" -%}{%- endif -%}
{%- assign lang = lang | downcase | strip -%}

{%- assign to_en = "/en/" -%}
{%- assign to_ja = "/" -%}
{%- if page.link_en -%}{%- assign to_en = page.link_en | relative_url -%}{%- endif -%}
{%- if page.slug_en -%}{%- assign to_en = "/en/" | append: page.slug_en | append: "/" | relative_url -%}{%- endif -%}
{%- if page.link -%}{%- assign to_ja = page.link | relative_url -%}{%- endif -%}
{%- if page.slug -%}{%- assign to_ja = "/" | append: page.slug | append: "/" | relative_url -%}{%- endif -%}

{%- assign current_url = page.url -%}
{%- if current_url == nil -%}{%- assign current_url = "" -%}{%- endif -%}

<div class="nav-controls">
  <button class="menu-toggle" aria-expanded="false" aria-controls="nav-links">
    <span class="menu-label">Menu</span>
  </button>

  <nav id="nav-links" class="links" aria-label="Primary">
    <ul>
      {%- assign _nav = nav -%}
      {%- assign _nav_is_empty = false -%}
      {%- if _nav == nil or _nav == empty -%}{%- assign _nav_is_empty = true -%}{%- endif -%}

      {%- if _nav_is_empty -%}
        {%- capture _fallback -%}
about|ABOUT|/|ABOUT|/en/
member|MEMBER|/member/|MEMBER|/en/member/
news|NEWS|/news/|NEWS|/en/news/
contribution|CONTRIBUTION|/contribution/|CONTRIBUTION|/en/contribution/
publication|PUBLICATION|/publication/|PUBLICATION|/en/publication/
partner|PARTNER|/partner/|PARTNER|/en/partner/
contact|CONTACT|/contact/|CONTACT|/en/contact/
        {%- endcapture -%}
        {%- assign _lines = _fallback | split: "\n" -%}
        {%- for _line in _lines -%}
          {%- assign _line = _line | strip -%}
          {%- if _line == "" -%}{%- continue -%}{%- endif -%}
          {%- assign p = _line | split: "|" -%}
          {%- assign _key = p[0] -%}
          {%- assign _label = p[1] -%}
          {%- assign _url = p[2] -%}
          {%- assign _label_en = p[3] -%}
          {%- assign _url_en = p[4] -%}
          {%- assign item_url = _url -%}
          {%- assign label = _label -%}
          {%- if lang == "en" -%}{%- assign item_url = _url_en -%}{%- assign label = _label_en -%}{%- endif -%}

          {%- assign active = "" -%}
          {%- if current_url == item_url -%}{%- assign active = " is-active" -%}{%- endif -%}
          {%- if active == "" and current_url contains item_url and _key != "about" -%}{%- assign active = " is-active" -%}{%- endif -%}

          {%- assign classes = "nav-link" | append: active -%}
          <li>
            <a class="{{ classes }}" href="{{ item_url | relative_url }}"><span>{{ label }}</span></a>
          </li>
        {%- endfor -%}
      {%- else -%}
        {%- for item in _nav -%}
          {%- assign item_url = item.url -%}
          {%- if lang == "en" and item.url_en -%}{%- assign item_url = item.url_en -%}{%- endif -%}
          {%- if item_url == nil -%}{%- assign item_url = "" -%}{%- endif -%}
          {%- if item_url contains "#" -%}{%- continue -%}{%- endif -%}
          {%- assign first_char = item_url | slice: 0, 1 -%}
          {%- if first_char == "#" -%}{%- continue -%}{%- endif -%}

          {%- assign active = "" -%}
          {%- if current_url == item_url -%}{%- assign active = " is-active" -%}{%- endif -%}
          {%- if active == "" and current_url contains item_url and item.key != "about" -%}{%- assign active = " is-active" -%}{%- endif -%}

          {%- assign label = item.label -%}
          {%- if lang == "en" and item.label_en -%}{%- assign label = item.label_en -%}{%- endif -%}

          {%- assign classes = "nav-link" | append: active -%}
          <li>
            <a class="{{ classes }}" href="{{ item_url | relative_url }}">
              <span>{{ label }}</span>
            </a>
          </li>
        {%- endfor -%}
      {%- endif -%}

        <li class="lang-switch">
          {% if lang == "en" %}
            <a class="nav-link" href="{{ to_ja }}"><span>JP</span></a>
          {% else %}
            <a class="nav-link" href="{{ to_en }}"><span>EN</span></a>
          {% endif %}
        </li>
    </ul>
  </nav>
  <div class="nav-backdrop" hidden></div>
</div>

<style>
  .nav-backdrop{
    position: fixed !important;
    inset: 0;
    background: rgba(0,0,0,.4);
    backdrop-filter: blur(2px);
    z-index: 2147483646 !important;
    pointer-events: none;
  }
  /* Ensure backdrop only shows when nav is open and always on top */
  .nav-open .nav-backdrop{
    display: block;
    z-index: 2147483646 !important;
    pointer-events: auto;
  }
  .nav-backdrop[hidden]{display:none}

  /* Top-right menu panel (mobile/overlay) */
  #nav-links {
    flex: 1 1 auto;              /* occupy remaining space */
    display: flex;
    justify-content: flex-end;   /* push items to the right */
    position: fixed !important;
    top: 0;
    right: max(16px, env(safe-area-inset-right));
    left: auto;
    width: min(240px, 72vw);
    height: auto;
    max-height: calc(100vh - 24px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 0.7rem 0.9rem;
    padding-bottom: max(0.7rem, env(safe-area-inset-bottom));
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    pointer-events: auto;
    background: var(--surface);
    border: 2px solid #000;
    border-radius: 12px;
    color: var(--ink);
    display: none;
    z-index: 2147483647 !important;
    /* Make nav-links a flex container to allow ul to fill height */
    flex-direction: column;
  }
  /* Always keep nav-links on top and visible when open */
  .nav-open #nav-links {
    z-index: 2147483647 !important;
    display: block;
    top: 0;
    right: max(16px, env(safe-area-inset-right));
    left: auto;
    position: fixed !important;
  }
  #nav-links a{position:relative; z-index:2}
  #nav-links.open{display:block}
  #nav-links ul{
    list-style:none;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:.25rem;
    /* Make ul scrollable if content is too tall */
    overflow-y: auto;
    max-height: calc(100vh - 24px - 1.4rem); /* nav max-height minus nav padding */
  }
  #nav-links.open ul{align-items:flex-end;text-align:right}
  #nav-links.open li{text-align:right}
  #nav-links.open .nav-link{display:inline-block;text-align:right;width:auto}
  #nav-links li{margin:0}
  #nav-links .nav-link{
    color: var(--ink);
    border:1px solid rgba(0,0,0,.14);
    border-radius:10px;
    padding:.55rem .75rem;
    background:transparent;
    transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
  }
  #nav-links .nav-link:hover{
    background: rgba(0,0,0,.10);
    border-color: rgba(0,0,0,.35);
    transform: translateY(-1px);
  }
  /* Overlay: slightly stronger hover contrast */
  .nav-open #nav-links .nav-link:hover{
    background: color-mix(in srgb, #ffffff 14%, transparent);
    border-color: color-mix(in srgb, #ffffff 40%, transparent);
  }

  /* Desktop: inline nav (no overlay) */
  @media (min-width: 960px){
    .menu-toggle{display:none}
    /* Desktop: show inline nav, not overlay */
    #nav-links{ position:static; top:auto; right:auto; left:auto; display:block; background:transparent; color:inherit; border:0; border-radius:0; padding:0; width:auto; box-shadow:none; flex: 1 1 auto; }
    #nav-links ul{display:flex; flex-direction:row; gap:.5rem}
    #nav-links .nav-link{color:var(--ink); border:1px solid transparent; border-radius:10px; padding:.45rem .65rem}
    #nav-links .nav-link:hover{
      background: color-mix(in srgb, #ffffff 12%, transparent);
      border-color: transparent;
      transform: translateY(-1px);
    }
    #nav-links .nav-link.is-active{border-color:transparent}
  }

  /* Keep menu button always clickable */
  .menu-toggle{position:relative; z-index:10000}
  @media (max-width: 959px){
    #nav-links{ margin-left: 0; padding-left: 0; }
  }
</style>